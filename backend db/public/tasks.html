<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width" />
<title>Список пользователей</title>
<link
href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
rel="stylesheet" />
</head>
<body>
<h2>Список пользователей</h2>
<form name="userForm">
<input type="hidden" name="id" value="0" />
<input type="hidden" name="id_user" value="mail@bk.ru" />
<div class="form-group">
<label for="mail">Вопрос:</label>
<input class="form-control" name="task" />
</div>
<div class="form-group">
<label for="password">Ответ:</label>
<input class="form-control" name="message" />
</div>
<div class="panel-body">
<button type="submit" class="btn btn-sm
btn-primary">Сохранить</button>
<a id="reset" class="btn btn-sm btn-primary">Сбросить</a>
</div>
</form>
<table class="table table-condensed table-striped table-bordered">
<thead><tr><th>Id</th><th>Почта</th><th>Вопрос</th><th>Ответ</th><th>Дата</th><th></th></tr></thead>
<tbody>
</tbody>
</table>

<script>
// Получение всех пользователей
async function getUsers() {
// отправляет запрос и получаем ответ
const response = await fetch("/api/daily_tasks", {
method: "GET",
headers: { "Accept": "application/json" }
});
// если запрос прошел нормально
if (response.ok === true) {
// получаем данные
const users = await response.json();
let rows = document.querySelector("tbody");
users.forEach(user => {
// добавляем полученные элементы в таблицу
rows.append(row(user));
});
}
}

// Добавление пользователя
async function createUser(userMail, userTask, userMessage) {
const response = await fetch("api/daily_tasks", {
method: "POST",
headers: { "Accept": "application/json", "Content-Type":
"application/json" },
body: JSON.stringify({
id_user: userMail,
task: userTask,
message: userMessage,
})
});
if (response.ok === true) {
const user = await response.json();
reset();
document.querySelector("tbody").append(row(user));
}
}

// сброс формы
function reset() {
const form = document.forms["userForm"];
form.reset();
form.elements["id"].value = 0;
}
// создание строки для таблицы
function row(user) {
const tr = document.createElement("tr");
tr.setAttribute("data-rowid", user._id);
const idTd = document.createElement("td");
idTd.append(user._id);
tr.append(idTd);
const mailTd = document.createElement("td");
mailTd.append(user.id_user);
tr.append(mailTd);
const taskTd = document.createElement("td");
taskTd.append(user.task);
tr.append(taskTd);
const messageTd = document.createElement("td");
messageTd.append(user.message);
tr.append(messageTd);
const dateTd = document.createElement("td");
dateTd.append(user.date);
tr.append(dateTd);
return tr;
}
// сброс значений формы
document.getElementById("reset").addEventListener("click", e => {
e.preventDefault();
reset();
})
// отправка формы
document.forms["userForm"].addEventListener("submit", e => {
e.preventDefault();
const form = document.forms["userForm"];
const mail = form.elements["id_user"].value;
const task = form.elements["task"].value;
const message = form.elements["message"].value;
createUser(mail, task, message);

// загрузка пользователей
getUsers();
})
</script>
</body>
</html>
