<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width" />
<title>Список пользователей</title>
<link
href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
rel="stylesheet" />
</head>
<body>
<h2>Список пользователей</h2>
<form name="userForm">
<input type="hidden" name="id" value="0" />
<div class="form-group">
<label for="message">Сообщение:</label>
<input class="form-control" name="message" />
</div>
<div class="panel-body">
<button type="submit" class="btn btn-sm
btn-primary">Сохранить</button>
<a id="reset" class="btn btn-sm btn-primary">Сбросить</a>
</div>
</form>
<table class="table table-condensed table-striped table-bordered">
<thead><tr><th>Id</th><th>Сообщение</th><th>Время</th><th>Отправитель</th><th></th></tr></thead>
<tbody>
</tbody>
</table>
<script>
// Получение всех пользователей
async function getUsers() {
// отправляет запрос и получаем ответ
const response = await fetch("/api/chat", {
method: "GET",
headers: { "Accept": "application/json" }
});
// если запрос прошел нормально
if (response.ok === true) {
// получаем данные
const users = await response.json();
let rows = document.querySelector("tbody");
users.forEach(user => {
// добавляем полученные элементы в таблицу
rows.append(row(user));
});
}
}
// Получение одного пользователя
async function getUser(id) {
const response = await fetch("/api/chat/" + id, {
method: "GET",
headers: { "Accept": "application/json" }
});
if (response.ok === true) {
const user = await response.json();
const form = document.forms["userForm"];
form.elements["message"].value = user.message;

}
}
// Добавление пользователя
async function createUser(userMessage) {
const response = await fetch("api/chat", {
method: "POST",
headers: { "Accept": "application/json", "Content-Type":
"application/json" },
body: JSON.stringify({
mail: "mail@bk.ru",
message: userMessage,
})
});
if (response.ok === true) {
const user = await response.json();
reset();
document.querySelector("tbody").append(row(user));
}
}


// сброс формы
function reset() {
const form = document.forms["userForm"];
form.reset();
form.elements["id"].value = 0;
}
// создание строки для таблицы
function row(user) {
const tr = document.createElement("tr");
tr.setAttribute("data-rowid", user._id);
const idTd = document.createElement("td");
idTd.append(user.id_user);
tr.append(idTd);
const messageTd = document.createElement("td");
messageTd.append(user.message);
tr.append(messageTd);
const dateTd = document.createElement("td");
dateTd.append(user.date);
tr.append(dateTd);
const senderTd = document.createElement("td");
senderTd.append(user.sender);
tr.append(senderTd);
const linksTd = document.createElement("td");
const editLink = document.createElement("a");
editLink.setAttribute("data-id", user._id);
editLink.setAttribute("style", "cursor:pointer;padding:15px;");
editLink.append("Изменить");
editLink.addEventListener("click", e => {
e.preventDefault();
getUser(user._id);
});
linksTd.append(editLink);
const removeLink = document.createElement("a");
removeLink.setAttribute("data-id", user._id);
removeLink.setAttribute("style", "cursor:pointer;padding:15px;");
removeLink.append("Удалить");
removeLink.addEventListener("click", e => {
e.preventDefault();
deleteUser(user._id);
});
linksTd.append(removeLink);
tr.appendChild(linksTd);
return tr;
}
// сброс значений формы
document.getElementById("reset").addEventListener("click", e => {
e.preventDefault();
reset();
})
// отправка формы
document.forms["userForm"].addEventListener("submit", e => {
e.preventDefault();
const form = document.forms["userForm"];
const id = form.elements["id"].value;
const message = form.elements["message"].value;
if (id == 0)
createUser(message);
});
// загрузка пользователей
getUsers();
</script>
</body>
</html>
